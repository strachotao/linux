# update-and-patch.yml; version 2020-03-11; strachotao
#  playbook na upgrade jadra + sys balicku
#
#  wget https://raw.githubusercontent.com/strachotao/linux/master/update-and-patch.yml 
#
#  TODO: rozsirit pro Ubuntu LTS 

---
- hosts: *
  become: yes
  gather_facts: yes

  tasks:
    - name: make backup directory
      file:
        path: /root/update
        state: directory
        owner: root
        group: root
        mode: 0755
          
    - name: backup /etc to backup directory
      command: tar -czpf "/root/update/etc.{{ansible_date_time.iso8601}}.tgz" /etc
      warn: false
      
    - name: update the system
      yum:
        name: "*"
        state: latest
        exclude: munin*
        disablerepo: "el6*,el7*"
        disable_gpg_check: yes
      register: updated_by_yum
      when: ansible_pkg_mgr == "yum"

    - name: restart system to reboot to newest kernel
      shell: "sleep 5 && reboot"
        async: 1
        poll: 0
      when: updated_by_yum.changed

    - name: wait for 40 seconds
      pause: seconds=40
      when: updated_by_yum.changed

    - name: wait for the system to reboot
      wait_for_connection:
        connect_timeout: 30
        sleep: 5
        delay: 5
        timeout: 80
      when: updated_by_yum.changed
